# Messages
TBD 

## Session Handling

```text
   ,------.                                    ,------.
   | Peer |                                    | Peer |
   `--+---'                                    `--+---'
      |               TCP established             |
      |<----------------------------------------->|
      |                                           |
      |               TLS established             |
      |+<--------------------------------------->+|
      |+                                         +|
      |+           WebSocket established         +|
      |+|<------------------------------------->|+|
      |+|                                       |+|
      |+|            WAMP established           |+|
      |+|+<----------------------------------->+|+|
      |+|+                                     +|+|
      |+|+                                     +|+|
      |+|+            WAMP closed              +|+|
      |+|+<----------------------------------->+|+|
      |+|                                       |+|
      |+|                                       |+|
      |+|            WAMP established           |+|
      |+|+<----------------------------------->+|+|
      |+|+                                     +|+|
      |+|+                                     +|+|
      |+|+            WAMP closed              +|+|
      |+|+<----------------------------------->+|+|
      |+|                                       |+|
      |+|           WebSocket closed            |+|
      |+|<------------------------------------->|+|
      |+                                         +|
      |+              TLS closed                 +|
      |+<--------------------------------------->+|
      |                                           |
      |               TCP closed                  |
      |<----------------------------------------->|
      |                                           |
   ,--+---.                                    ,--+---.
   | Peer |                                    | Peer |
   `------'                                    `------'
```

<a name="Connect"></a>

### Connect
It is the message your client application sends to the [Akka I/O extension manager](../client/actor/session/#access-the-manager) to connect a transport to a remote router. It can be constructed passing the following parameters:

* ``client``  
  It is your client actor reference to which messages from the router are delivered back.

* ``url``  
  It is the [URL](https://www.ietf.org/rfc/rfc1738.txt) of the router listener. By default Akka Wamp makes use of ``ws://127.0.0.1:8080/ws`` and it currently supports the following protocols:

    * ``tcp``  
        Raw TCP
    * ``tsl``  
        Transport Secure Layer
    * ``ws``  
        WebSocket 
    * ``wss``  
        WebSocket over TLS

* ``subprotocol``  
  It is the [subprotocol](https://www.iana.org/assignments/websocket/websocket.xml#subprotocol-name) you wish to negotiate with the router. By default Akka Wamp makes use of ``wamp.2.json`` and it currently supports the following subprotocols:
  
    * ``wamp.2.json``
    * ``wamp.2.msgpack``
  
Examples:

```scala
IO(Wamp) ! Connect(client)
IO(Wamp) ! Connect(client, url = "wss://secured.host.net:8433/path/to/router")
IO(Wamp) ! Connect(client, subprotocol = "wamp.2.mgspack")
```

<a name="Hello"></a>

### Hello
It is the message your client application sends to the router to request a new session being opened with the given realm attached plus additional details. It can be constructed passing the following parameters:

* ``realm``  
  It is the realm identifier given as [URI](https://tools.ietf.org/html/draft-oberstet-hybi-tavendo-wamp-02#section-5.1.1). By default, Akka Wamp sends ``akka.wamp.realm``

* ``details``  
   It is a dictionary of additional details. By default, Akka Wamp makes a dictionary with all possible client roles its supports:

    * ``subscriber``
    * ``publisher``

Examples:

```scala
connection ! Hello()
connection ! Hello("myapp.realm")
connection ! Hello(details = Dict().withRoles("subscriber"))
connection ! Hello("myapp.realm", Dict().withRoles("publisher"))
```


<a name="Abort"></a>

### Abort
TBD

<a name="Welcome"></a>

### Welcome
It is the message you receive from the router upon session opening. It can be deconstructed (via Scala pattern matching) to the following parameters:

* ``sessionId``  
  It is the session identifier as generated by the router.

* ``details``  
  It is a dictionary with additional details (for example the router agent identifier)

Examples:

```scala
val sessionId: Long = _

def receive: Receive = {
  case Welcome(sessionId, details) =>
    log info s"Session $sessionId opened with $details"
    this.sessionId = sessionId
    context become opened
}

def opened: Receive = {
  case Goodbye =>
    this.sessionId = 0

  // case ...  
}
```

<a name="Goodbye"></a>

### Goodbye
It is the message either your client application sends to the router or receive from the router to request session closing. It can be constructed (deconstructed) with (to) the following parameters:

* ``reason``  
  It is the reason identifier given as [session close URI](https://tools.ietf.org/html/draft-oberstet-hybi-tavendo-wamp-02#section-10.1.3). By default, Akka Wamp sends ``wamp.error.close_realm``

* ``details``  
  It is a dictionary of additional details. By default, Akka Wamp sends an empty dictionary.

Some sending snippets are:

```scala
connection ! Goodbye()
connection ! Goodbye("wamp.error.system_shutdown")
connection ! Goodbye(details = Dict().withEntry(reason -> "Serious error occured!"))
```

A receiving snippet is:

```scala
def opened: Receive = {
  case Goodbye(reason, details) =>
    log warn s"Router closed session because of $details"
    connection ! Goodbye("wamp.error.goodbye_and_out")
    if (reason != "wamp.error.system_shutdown")
      // why not requesting a new session 
      connection ! Hello
    else
      IO(Wamp) ! Connect(self)
}
```

> NOTE: there's an open [issue#242]((https://github.com/wamp-proto/wamp-proto/issues/242) on GitHub about the ``Goodbye`` message to warn you that some remote routers could decide to disconnect the transport in addition to close the session. If that happens the you'll be forced to reconnect.

<a name="Error"></a>

### Error
TBD


## Publish Subscribe

<a name="Subscribe"></a>

### Subscribe
It is the message your client application sends to the router to subscribe to a topic. It can be constructed passing the following parameters:

* ``requestId``
  It is the request identifier you have to generate in _"session scope"_. AkkaWamp provides you with a ``Scope.Session`` trait you can mixin to invoke ``nextId()``

* ``topic``  
  It is the topic URI you want to subscribe to.

* ``options``  
  It is a dictionary of additional details. By default, Akka Wamp sends an empty dictionary.

Examples:

```scala
connection ! Subscribe(requestId = 34, "myapp.tick.topic")
```

<a name="Subscribed"></a>

### Subscribed
TBD


<a name="Publish"></a>

### Publish
It is the message your client application sends to the router to publish an event. It can be constructed passing the following parameters:

* ``requestId``  
  It is the request identifier you have to generate in _"session scope"_. AkkaWamp provides you with a ``Scope.Session`` trait you can mixin to invoke ``nextId()``

* ``topic``  
  It is the topic URI to which you wish to publish to

* ``payload``  
  It is the (option of) payload you could provide to send data arguments. By default, Akka Wamp sends none but you could create some as documented in the [Payload](#payload) section below.

* ``options``  
  It is a dictionary of additional details (for example with the ``"acknowledge" -> true`` entry if you wish to receive the ``Published`` message from the router). By default, Akka Wamp sends an empty dictionary.

Examples:

```scala
connection ! Publish(requestId = 34, "myapp.tick.topic")

val list = Payload("paolo", 40, true)
connection ! Publish(nextId(), "myapp.topic1", Some(list))

val mixed = Payload("paolo", "age"->40, true)
connection ! Publish(nextId(), "myapp.topic1", Some(mixed))

connection ! Publish(89, "myapp.topic3", options = Dict().withAcknowledge(true))
```


<a name="Event"></a>

### Event
It is the message you receive from the router each time other clients have published to the same topics you subscribed to. It can be deconstructed (via Scala pattern matching) to the following parameters:

* ``subscriptionId``    
  It is the subscription identifier you could use to figure out which topic the event has been fired for.

* ``publicationId``    
   It is the publication identifier generated by the router in global scope.

* ``payload``    
  It is the (option of) payload with data arguments you could read as documented in the [Payload](#payload) section below.

* ``details``  
  It is a dictionary with additional details.

Examples:

```scala
val subscriptionId: Long = _

def opened: Receive = {
  case Event(subscriptionId, publicationId, None, details) =>
    log debug s"Event received for subscription $subscriptionId"

  case Event(_, _, Some(payload), _) =>
    log debug s"Event receive with payload $payload"
}
```



## Remote Procedure Calls

<a name="Register"></a>

### Register
TBD

<a name="Call"></a>

### Call
TBD

<a name="Invoke"></a>

### Invoke
TBD

<a name="Yield"></a>

### Yield
TBD

<a name="Result"></a>

### Result
TBD
