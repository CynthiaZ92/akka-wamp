## Connections and Sessions
```
   ,------.                                    ,------.
   | Peer |                                    | Peer |
   `--+---'                                    `--+---'
      |               TCP established             |
      |<----------------------------------------->|
      |                                           |
      |               TLS established             |
      |+<--------------------------------------->+|
      |+                                         +|
      |+           WebSocket established         +|
      |+|<------------------------------------->|+|
      |+|                                       |+|
      |+|            WAMP established           |+|
      |+|+<----------------------------------->+|+|
      |+|+                                     +|+|
      |+|+                                     +|+|
      |+|+            WAMP closed              +|+|
      |+|+<----------------------------------->+|+|
      |+|                                       |+|
      |+|                                       |+|
      |+|            WAMP established           |+|
      |+|+<----------------------------------->+|+|
      |+|+                                     +|+|
      |+|+                                     +|+|
      |+|+            WAMP closed              +|+|
      |+|+<----------------------------------->+|+|
      |+|                                       |+|
      |+|           WebSocket closed            |+|
      |+|<------------------------------------->|+|
      |+                                         +|
      |+              TLS closed                 +|
      |+<--------------------------------------->+|
      |                                           |
      |               TCP closed                  |
      |<----------------------------------------->|
      |                                           |
   ,--+---.                                    ,--+---.
   | Peer |                                    | Peer |
   `------'                                    `------'
```

<a name="Connect"></a>

### Connect
It is the message you send to the Akka IO entry point to establish a WAMP connection to a router. It can be constructed passing the following parameters:

* ``client``  
  It is your client actor reference to which messages from the remote router are delivered while the connection is established.

* ``url``  
  It is the [URL](https://www.ietf.org/rfc/rfc1738.txt) to the remote router. By default Akka Wamp makes use of ``ws://127.0.0.1:8080/ws`` and it currently supports the following protocols:

  * ``ws``  
    It is the WebSocket protocol.

* ``subprotocol``  
  It is the [subprotocol](https://www.iana.org/assignments/websocket/websocket.xml#subprotocol-name) you wish to negotiate with the remote router.
  
Examples:

```scala
IO(Wamp) ! Connect(client)
IO(Wamp) ! Connect(client, url = "ws://router.host.net:8080/path/to/ws")
IO(Wamp) ! Connect(client, subprotocol = "wamp.2.mgspack")
```


### <a name="Hello"></a>Hello
It is the message you send to the transport to request a new session being opened with the given realm attached plus additional details. It can be constructed passing the following parameters:

* ``realm``  
  It is the realm identifier given as [URI](https://tools.ietf.org/html/draft-oberstet-hybi-tavendo-wamp-02#section-5.1.1). By default, Akka Wamp sends ``akka.wamp.realm``

* ``details``  
   It is a dictionary of additional details. By default, Akka Wamp makes a dictionary with all possible client roles its supports:

    * ``subscriber``
    * ``publisher``

Examples:

```scala
connection ! Hello()
connection ! Hello("myapp.realm")
connection ! Hello(details = Dict().withRoles("subscriber"))
connection ! Hello("myapp.realm", Dict().withRoles("publisher"))
```


<a name="Abort"></a>

### Abort
TBD

<a name="Welcome"></a>

### Welcome
It is the message you receive from the remote router upon session opening. It can be deconstructed (via Scala pattern matching) to the following parameters:

* ``sessionId``  
  It is the session identifier as generated by the remote router.

* ``details``  
  It is a dictionary with additional details (for example the remote router agent identifier)

Examples:

```scala
val sessionId: Long = _

def receive: Receive = {
  case Welcome(sessionId, details) =>
    log info s"Session $sessionId opened with $details"
    this.sessionId = sessionId
    context become opened
}

def opened: Receive = {
  case Goodbye =>
    this.sessionId = 0

  // case ...  
}
```

<a name="Goodbye"></a>

### Goodbye
It is the message either you send to the transport or receive from the remote router to request session closing. It can be constructed (deconstructed) with (to) the following parameters:

* ``reason``  
  It is the reason identifier given as [session close URI](https://tools.ietf.org/html/draft-oberstet-hybi-tavendo-wamp-02#section-10.1.3). By default, Akka Wamp sends ``wamp.error.close_realm``

* ``details``  
  It is a dictionary of additional details. By default, Akka Wamp sends an empty dictionary.

Some sending snippets are:

```scala
connection ! Goodbye()
connection ! Goodbye("wamp.error.system_shutdown")
connection ! Goodbye(details = Dict().withEntry(reason -> "Serious error occured!"))
```

A receiving snippet is:

```scala
def opened: Receive = {
  case Goodbye(reason, details) =>
    log warn s"Router closed session because of $details"
    connection ! Goodbye("wamp.error.goodbye_and_out")
    if (reason != "wamp.error.system_shutdown")
      // why not requesting a new session 
      connection ! Hello
    else
      IO(Wamp) ! Connect(self)
}
```

> NOTE: there's an open [issue#242]((https://github.com/wamp-proto/wamp-proto/issues/242) on GitHub about the ``Goodbye`` message to warn you that some remote routers could decide to disconnect the transport in addition to close the session. If that happens the you'll be forced to reconnect.

# Subscriber and Publisher

<a name="Subscribe"></a>

### Subscribe
It is the message you send to the transport to subscribe to a topic. It can be constructed passing the following parameters:

* ``requestId``
  It is the request identifier you have to generate in _"session scope"_. AkkaWamp provides you with a ``Scope.Session`` trait you can mixin to invoke ``nextId()``

* ``topic``  
  It is the topic URI you want to subscribe to.

* ``options``  
  It is a dictionary of additional details. By default, Akka Wamp sends an empty dictionary.

Examples:

```scala
connection ! Subscribe(requestId = 34, "myapp.tick.topic")
```

<a name="Subscribed"></a>

### Subscribed
TBD

<a name="publish"></a>

### Publish
It is the message you send to the transport to publish an event. It can be constructed passing the following parameters:

* ``requestId``  
  It is the request identifier you have to generate in _"session scope"_. AkkaWamp provides you with a ``Scope.Session`` trait you can mixin to invoke ``nextId()``

* ``topic``  
  It is the topic URI to which you wish to publish to

* ``payload``  
  It is the (option of) payload you could provide to send data arguments. By default, Akka Wamp sends none but you could create some as documented in the [Payload](#payload) section below.

* ``options``  
  It is a dictionary of additional details (for example with the ``"acknowledge" -> true`` entry if you wish to receive the ``Published`` message from the router). By default, Akka Wamp sends an empty dictionary.

Examples:

```scala
connection ! Publish(requestId = 34, "myapp.tick.topic")

val list = Payload("paolo", 40, true)
connection ! Publish(nextId(), "myapp.topic1", Some(list))

val mixed = Payload("paolo", "age"->40, true)
connection ! Publish(nextId(), "myapp.topic1", Some(mixed))

connection ! Publish(89, "myapp.topic3", options = Dict().withAcknowledge(true))
```

<a name="Error"></a>

### Error
TBD


<a name="Event"></a>

### Event
It is the message you receive from the remote router each time other clients have published to the same topics you subscribed to. It can be deconstructed (via Scala pattern matching) to the following parameters:

* ``subscriptionId``    
  It is the subscription identifier you could use to figure out which topic the event has been fired for.

* ``publicationId``    
   It is the publication identifier generated by the remote router in global scope.

* ``payload``    
  It is the (option of) payload with data arguments you could read as documented in the [Payload](#payload) section below.

* ``details``  
  It is a dictionary with additional details.

Examples:

```scala
val subscriptionId: Long = _

def opened: Receive = {
  case Event(subscriptionId, publicationId, None, details) =>
    log debug s"Event received for subscription $subscriptionId"

  case Event(_, _, Some(payload), _) =>
    log debug s"Event receive with payload $payload"
}
```

<a name="Payload"></a>

## Serialization

### Payload
An (option of) Payload is carried by either [Error](#error), [Publish](#publish) or [Event](#event) messages. Akka Wamp provides easy ways to both create and handle payloads.

You can create some outgoing payload for the [Publish](#publish) message by invoking the following factory method

```scala
object Payload {
  def apply(arguments: Any*): Payload
}
```

which means you can pass in any number of arguments in any type you like. For example:

```scala
val payload = Payload("paolo", 40, true)
connection ! Publish(nextId(), Some(payload)
// serializes to [... , ["paolo", 40, true]]
```

You can even pass any number of key-value pairs alongside with any (or no) value. For example:

```scala
val payload = Payload("paolo", 40, "height"->1.65, true)
// serializes to [... , ["paolo", 40, true], {"height"->1.65}]
```

Akka Wamp will take care of serializing the arguments you pass in the right way.

You can handle some incoming payload carried by either [Error](#error) or [Event](#event) messages and turn it into a list or into a dictionary as follows:

```scala
val args: List[Any] = for (p <- message.payload) p.asList
  
// OR turn it into dictionary
  
val args: Map[String, Any] = for (p <- message.payload) p.asDict
```
